---
title: "ECON_144_Project_2"
author: "Marc Luzuriaga, Sia Gao, Reagan Lee, Jiaxuan Huang"
date: "2024-11-10"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(quantmod)
library(readxl)
library(tsibble)
library(tidyr)
library(ggplot2)
library(USgas)
library(ymd)
library(hash)
library(fpp3)
library(readr)
library(lubridate)
library(quantmod)
library(e1071)
library(moments)
library(lmtest)
library(tseries)
library(forecast)
library(fpp2)
library(vars)
library(strucchange)
```

# ECON 144 Project 2

# Introduction

In this paper, we aim to develop a comprehensive analysis of two interconnected financial and economic time series: the gas price index and the stock price of Chevron Corporation. Our objectives are twofold: (1) to create robust forecasting models for both the gas price index and Chevron's stock price that incorporate trend, seasonality, and cyclical components, and (2) to evaluate the dynamic relationship between these two variables using Vector Autoregressive (VAR) models, Vector Moving Average (VMA) models, and Granger causality tests.

To achieve these goals, we will first fit individual time-series models for each variable and assess their respective trends, seasonal patterns, and cyclical behaviors over a time horizon of approximately 10 years to capture long-term movements. These models will be used to produce 12-step-ahead forecasts and compared with benchmarks such as the `auto.arima()` model to determine forecasting accuracy, measured by Mean Absolute Percentage Error (MAPE).

In addition, we will assess the interactions between the gas price index and Chevron stock prices by constructing a VAR model. This will allow us to analyze how shocks to one variable impact the other over time, which will be further examined through impulse response functions. Finally, Granger causality tests will be performed to determine the directional causality between the two series, providing insights into potential leading and lagging relationships between the gas price index and Chevron stock performance.

# Results

## (a) Time-Series Plot of Data

Let us load the data for both the gas price index and chevron stock price as follows:

```{r}
# Define start date for the past decade (approximate 10 years ago)
start_date <- Sys.Date() - (10 * 52 * 7)  # Approximate 10 years in weeks
# Load the gas price index from the last ten years
getSymbols("GASREGW", src = "FRED", periodicity = "weekly", from = start_date)
gas_price_index <- na.omit(GASREGW)
# Load the Chevron stock price from the last ten years
getSymbols("CVX", src = "yahoo", periodicity = "weekly", from = start_date)
cvx_price  <- na.omit(Cl(CVX))
```

We will proceed to plot the gas price index data, along with the respective ACF and PACF plots as follows:

```{r}
# Plot the gas price index
plot(gas_price_index, 
     col = "blue", 
     main = "Gas Price Index (Last 10 Years)", 
     xlab = "Date", 
     ylab = "Gas Price Index")
# Plot the associated ACFs and PACFs of gas price index
tsdisplay(gas_price_index, main="Gas Price Index (Last 10 Years)")
```

Analyzing the respective ACF and PACF plots, we see that there is a slow decay in the ACF and two statistically significant spikes in the first and second lag. Hence, this suggests to us that we need to fit an AR(2) model.

We will proceed to plot the Chevron price, along with the respective ACF and PACF plots as follows:

```{r}
# Plot the Chevron (CVX) price
plot(cvx_price, 
     col = "green", 
     main = "Chevron (CVX) Closing Prices (Last 10 Years)", 
     xlab = "Date", 
     ylab = "CVX Closing Price")
# Plot the associated ACFs and PACFs of CVX
tsdisplay(cvx_price, main="Chevron (CVX) Closing Prices (Last 10 Years)")
```

Analyzing the respective ACF and PACF plots, we see that there is a slow decay in the ACF and a single statistically significant spike in the first lag. Hence, this suggests to us that we need to fit an AR(1) model.

## (b) STL Decomposition

We will proceed to perform an additive STL Decomposition for the gas price index as follows:

```{r}
#Create the associated ts object
gas_price_index_ts<- ts(gas_price_index$GASREGW, 
                              start = c(2014, 47), frequency = 52)
gas_price_index_decomp <- decompose(gas_price_index_ts)
plot(gas_price_index_decomp)
```

From the data above, we see a stable trend from 2014 to 2020. However, after that time period, there is an increase trend from 2020 to 2024. Also, we see an approximately yearly regular seasonal pattern from the seasonal plot above. If we observe the random component, we see that there are cycles that are still present in the residuals. We will have to take into account these cycles in our final model.

We will proceed to perform an additive STL decomposition for the Chevron stock price as follows:

```{r}
#Create the associated ts object
cvx_price_ts<- ts(cvx_price, 
                    start = c(2014, 47), frequency = 52)
cvx_price_decomp <- decompose(cvx_price_ts)
plot(cvx_price_decomp)
```

If we analyze the trend from the plot above, we see a similar trend to that of the gas price indexâ€”to which there is stability in the price from 2014 to 2020 and a clear upward trend from 2020 to 2024. As for the seasonal patterns, we see a periodicity of approximately a year, which is similar to that of the gas price index. However, the seasonal pattern is much more volatile and unstable compared to that of the gas price index. Finally, analyzing the random component, we see there are still cycles present in the residuals of our data.

## (c) Model fit of Trend, Seasonality, and Cyclical Components

We will propose the following model for the trend and seasonality of the gas price index: $$
Gas_t=T_t+T_t^2+\sum_{i=1}^{52}\gamma_iM_{i,t}+R_t
$$Let us first fit a model with a quadratic trend and weekly seasonal dummies using the tslm() function as follows:

```{r}
#Create the fit model object
fit_gas <- tslm(gas_price_index_ts ~ trend+ I(trend^2)+season)
#Plot the original data
plot(gas_price_index_ts, 
     main = "Gas Price Index with Quadratic Trend and Seasonality", 
     ylab = "Gas Price Index", 
     xlab = "Time")
#Plot the fitted model
lines(fitted(fit_gas), col="red")
#Create the legend
legend("topleft", 
       legend = c("Original Series", "Fitted Trend & Seasonality"), 
       col = c("black", "red"), 
       lty = 1, 
       cex = 0.8)
```

We can further analyze the seasonal dummies of our model by plotting the seasonal factors plot:

```{r}
# Create the seasonal plot object
fit_seasonal_gas <- tslm(gas_price_index_ts~season)
# Obtain the associated coefficients
seasonal_coefficients_gas <- coef(fit_seasonal_gas)[-1]
# Plot the associated coefficients
plot(seasonal_coefficients_gas, type = "o", 
     main="Seasonal Factors Plot For Gas Price Index",
     xlab="Season",
     ylab="Price Index")
#Summary of the coefficients
summary(fit_seasonal_gas)
```

From the seasonal factors plot, we see that the price index increases from the beginning of the year to approximately around week 23. Then, it decreases from week 23 to the end of the year. If we analyze the summary of the fit, we see that seasonality is indeed present from examining the non-statistically significant p-values.

Now, let us examine the remainder component from the fitted model as follows, as well as examine the ACF and PACF of the remainder:

```{r}
#Create the remainder object
gas_price_index_remainder <- gas_price_index_ts-fitted(fit_gas)
#Plot the remainder object
plot(gas_price_index_remainder, main="Gas Price Index Remainder")
#Examine the ACF and PACF of the remainder
tsdisplay(gas_price_index_remainder, lag.max=40, main="Gas Price Index Remainder")
```

From the model above, we see a slow decay in the ACF, as well as two statistically significant spikes in the first two lags of the PACF. Hence, we propose to fit an AR(2) model to the residuals as follows: $$
R_t=\phi_1R_{t-1}+\phi_2R_{t-2}+\epsilon_t
$$

Let us make this fit using the arima() function as follows:

```{r}
#Create the AR(2) object on hte gas price index remainder
resid_gas <- arima(gas_price_index_remainder, order=c(2,0,0))
#Plot the remainder
plot(gas_price_index_remainder, main="Gas Price Index Remainder", 
     ylab="Gas Price Index")
lines(fitted(resid_gas), col="Red")
legend("topleft", 
       legend = c("Original Series", "Fitted AR Model"), 
       col = c("black", "red"), 
       lty = 1, 
       cex = 0.8)
```

By visually inspecting the plot above, we see that the AR model does a pretty good job of fitting the data. We will proceed to plot the full model as follows:

```{r}
#Create the full model object
full_model_gas <- fitted(fit_gas) + fitted(resid_gas)
#Plot the remainder object
plot(gas_price_index_ts, main="Gas Price Index")
lines(full_model_gas, col="Red")
legend("topleft", 
       legend = c("Original Series", "Full Fitted Model"), 
       col = c("black", "red"), 
       lty = 1, 
       cex = 0.8)
```

We will propose the following model for the trend and seasonality of the Chevron stock as follows: $$
CVX_t=T_t+T_t^2+\sum_{i=1}^{52}\gamma_iM_{i,t}+R_t
$$

Let us first fit a model with a quadratic trend and weekly seasonal dummies using the tslm() function as follows:

```{r}
#Create the fit model object
fit_cvx <- tslm(cvx_price_ts ~ trend+ I(trend^2)+season)
#Plot the original data
plot(cvx_price_ts,       
     main = "Gas Price Index with Quadratic Trend and Seasonality",       
     ylab = "Gas Price Index",       
     xlab = "Time") 
#Plot the fitted model
lines(fitted(fit_cvx), 
      col="red")
#Create the legend
legend("topleft",         
       legend = c("Original Series", "Fitted Trend & Seasonality"),         
       col = c("black", "red"),         
       lty = 1,         
       cex = 0.8)
```

We can further analyze the seasonal dummies of our model by plotting the seasonal factors plot:

```{r}
# Create the seasonal plot object
fit_seasonal_cvx <- tslm(cvx_price_ts~season)
# Obtain the associated coefficients
seasonal_coefficients_cvx <- coef(fit_seasonal_cvx)[-1]
# Plot the associated coefficients
plot(seasonal_coefficients_cvx, type = "o", 
     main="Seasonal Factors Plot For CVX Price",
     xlab="Season",
     ylab="Price Index")
#Summary of the coefficients
summary(fit_seasonal_cvx)
```

From the seasonal factors plot, seasonality varies throughout the year with the price index bottoming at weeks 10 and 40, while peaking at weeks 20 and 45. If we analyze the summary of the fit, we see that seasonality is indeed present from examining the non-statistically significant p-values.

Now, let us examine the remainder component from the fitted model as follows, as well as examine the ACF and PACF of the remainder:

```{r}
#Create the remainder object 
cvx_index_remainder <- cvx_price_ts-fitted(fit_cvx) 
#Plot the remainder object 
plot(cvx_index_remainder, main="CVX Index Remainder") 
#Examine the ACF and PACF of the remainder 
tsdisplay(cvx_index_remainder, lag.max=40, main="CVX Index Remainder")
```

From the model above, we see a slow decay in the ACF, as well as a single statistically significant spike in the first lag of the PACF. Hence, we propose to fit an AR(1) model to the residuals as follows: $$ R_t=\phi_1R_{t-1}+\epsilon_t $$

Let us make this fit using the arima() function as follows:

```{r}
#Create the AR(1) object on the CVX remainder
resid_cvx <- arima(cvx_index_remainder, order=c(1,0,0)) 
#Plot the remainder 
plot(cvx_index_remainder, main="CVX Price Remainder",       
     ylab="Price") 
lines(fitted(resid_cvx), col="Red") 
legend("topleft",         
       legend = c("Original Series", "Fitted AR Model"),         
       col = c("black", "red"),         
       lty = 1,         
       cex = 0.8)
```

By visually inspecting the plot above, we see that the AR model does a pretty good job of fitting the data. We will proceed to plot the full model as follows:

```{r}
#Create the full model object
full_model_cvx <- fitted(fit_cvx) + fitted(resid_cvx)
#Plot the remainder object
plot(cvx_price_ts, main="Gas Price Index")
lines(full_model_cvx, col="Red")
legend("topleft", 
       legend = c("Original Series", "Full Fitted Model"), 
       col = c("black", "red"), 
       lty = 1, 
       cex = 0.8)
```

## (d) Analysis of Residuals vs Fitted Values

We will proceed to plot the residuals vs fitted values for our gas price index data as follows:

```{r}
plot(full_model_gas, full_model_gas-gas_price_index_ts,
     main="Residuals vs. Fitted Values of Gas Fit",
     xlab="Fitted Values",
     ylab="Residuals")
# Add a horizontal line at 0 for reference
abline(h = 0, col = "red", lwd = 2)
```

Analyzing the residuals vs fitted values of the gas plot, we see that the residuals are randomly distributed around 0 with no clear pattern. Although there are some outliers, the specific outliers don't hold much weight with respect to the rest of the points. Also, the spread of residuals appears to be consistent, suggesting that variance of the residuals exhibit homoscedasticity.

We will proceed to plot the residuals vs fitted values for our CVX price as follows:

```{r}
plot(full_model_cvx, full_model_cvx-cvx_price_ts,
     main="Residuals vs. Fitted Values of CVX Fit",
     xlab="Fitted Values",
     ylab="Residuals")
# Add a horizontal line at 0 for reference
abline(h = 0, col = "red", lwd = 2)
```

The residuals for the CVX fit are similar to that of the Gas fit. Analyzing the residuals vs fitted values of the gas plot, we see that the residuals are randomly distributed around 0 with no clear pattern. Also, the spread of residuals appears to be consistent, suggesting that variance of the residuals exhibit homoscedasticity.

## (e) ACF and PACF of respective residuals

We will proceed to plot the ACF and PACF of the respective residuals as follows:

```{r}
# ACF and PACF for gas price index residuals
tsdisplay(full_model_gas - gas_price_index_ts, 
          main="ACF and PACF of Gas Price Index Residuals")

# ACF and PACF for Chevron stock price (CVX) residuals
tsdisplay(full_model_cvx - cvx_price_ts, 
          main="ACF and PACF of CVX Price Residuals")

```

From the ACF and PACF of the residuals, we see that it appears that statistically significant lags appear to persist in some areas of the plot. However, it appears that there is no clear pattern to suggest that a seasonal AR model would fix the statistically significant lags. Other than the few statistically significant lags, the other parts appear to simulate white noise.

## (f) CUSUM Plot

We will proceed to plot the CUSUM as follows:

```{r}
# Calculate residuals by subtracting the fitted model from the actual data
gas_residuals <- gas_price_index_ts - full_model_gas
gas_efp <- efp(gas_residuals ~ 1, type = "Rec-CUSUM")
plot(gas_efp, main = "CUSUM Plot for Gas Price Index")

# (b) CUSUM Plot for CVX Price
# Calculate residuals by subtracting the fitted model from the actual data
cvx_residuals <- cvx_price_ts - full_model_cvx
cvx_efp <- efp(cvx_residuals ~ 1, type = "Rec-CUSUM")
plot(cvx_efp, main = "CUSUM Plot for CVX Price")
```

From the CUSUM Plots above, we see that the residuals stay within the confidence interval bands for both models. This suggests that there are no structural breaks in our model.

## (g) Diagnostic Statistics

We will proceed to assess the accuracy and perform a Ljung-Box Test on the residuals of the our full gas model to assess the appropriateness of our model:

```{r}
#Obtain associated error statistics
accuracy(full_model_gas, gas_price_index)
#Use Ljung-Box to test for white noise
Box.test(gas_residuals, type = "Ljung-Box")
```

From the above statistics, we see that the model is a pretty good fit to our data, with RMSE of 0.04878779 and MAPE of 1.215091. Interpreting the MAPE, we see that, on average, the model's predictions are off by around 1.2%, which is quite accurate. Furthermore, from the Ljung-Box test performed above, we see that the p-value of 0.9115 is non-statistically significant. This indicates that the residuals simulate white noise, which informs us that most of the dynamics have been captured by the model.

We will proceed to assess the accuracy and perform a Ljung-Box Test on the residuals of the our full gas model to assess the appropriateness of our model:

```{r}
#Obtain associated error statistics
accuracy(full_model_cvx, cvx_price)
#Use Ljung-Box to test for white noise
Box.test(cvx_residuals, type = "Ljung-Box")
```

From the above statistics, we see that the model is a pretty good fit to our data, with RMSE of 4.264305 and MAPE of 2.597912. Interpreting the MAPE, we see that, on average, the model's predictions are off by around 2.6%, which is quite accurate. Furthermore, from the Ljung-Box test performed above, we see that the p-value of 0.9964 is non-statistically significant. This indicates that the residuals simulate white noise, which informs us that most of the dynamics have been captured by the model.

## (h) Forecasting with Model

We will proceed to perform a 12-step ahead forecast for both the gas model and cvx model as follows:

```{r}

# Define the number of forecast periods
forecast_horizon <- 12

# Forecasting with the gas price model
gas_forecast <- forecast(full_model_gas, h = forecast_horizon)
print("Gas Price Index Forecast:")
print(gas_forecast)

# Forecasting with the Chevron (CVX) stock price model
cvx_forecast <- forecast(full_model_cvx, h = forecast_horizon)
print("Chevron (CVX) Stock Price Forecast:")
print(cvx_forecast)

# Plot gas price forecast
plot(gas_forecast, main = "Gas Price Index Forecast", 
     ylab = "Gas Price Index", xlab = "Time")

# Plot Chevron (CVX) stock price forecast
plot(cvx_forecast, main = "Chevron (CVX) Stock Price Forecast", 
     ylab = "CVX Stock Price", xlab = "Time")

```

## (i) Comparison to auto.arima() (Sia)

## (j) Combining the Model with auto.arima() (Sia)

## (k) The VAR Model (Jiaxuan)

From the model summary, we can find that for the regression towards gas, the lag 1 and 2 of CVX prices has a statistically high significance, as well as the log1 of gas price itself. The R-square is around 0.4. This indicates that gas price is explained reasonably well. However, none of the lagged terms are significant towards the prediction of CVX price and the R-square is around 0.003, so the model is not fitting well on CVX price, this is confirmed by our plot, where the fitted ice has similar pattern of the actual price, whereas the fitted CVX doesn't seem to have similar patterns

[**=======NOTES AND FEEDBACK START===========**]{.underline}

[Feedback 1:]{.underline}

Can you elaborate more on the code in this section outside of the comments? It has to be clear to the reader that we're differencing in order to make the data stationary and using the adf to check if the resulting data is indeed stationary; using the VARselection to determine the order of the model; and plotting the data. The format will look something like this:

"We will proceed to difference our data to make it stationary and perform an ADF test to statistically ensure that the data is indeed stationary:

[INSERT R MARKDOWN HERE]

From the ADF test we see that the . . . "

Essentially, what you're trying to do is explain what you're about to do, and then perform the action in an R markdown. It has to be clear to the reader what you're about to do in a sequential and logical fasion. Do the same when fitting the VAR Model and plotting the VAR Model

[Feedback 2:]{.underline}

Can you fix the axis and legend. It appears that, for one of the plots, the legend covers the plot.

[Feedback 3:]{.underline}

Move the interpretation of the model summary just below the call of the summary. Also, don't use R squared since it doesn't take into account the number of parameters. Interpret the fit using AIC, BIC, and Adjusted R Squared.

[**=======NOTES AND FEEDBACK END===========**]{.underline}

```{r}
# Load the percentage change of the gas price index for the past decade (weekly data)
gas_price_index_diff <- na.omit(diff(gas_price_index))
adf_test_result_gas <- adf.test(gas_price_index_diff)
adf_test_result_gas
plot(gas_price_index_diff)
tsdisplay(gas_price_index_diff)

# Load the percentage change of the TAN (solar ETF) closing stock price for the past decade (weekly data)
cvx_price_diff  <- na.omit(diff(cvx_price))
adf_test_result_cvx  <- adf.test(cvx_price_diff)
adf_test_result_cvx
plot(cvx_price_diff)
tsdisplay(cvx_price_diff)

# Combine the two time series into one dataset
data_diff <- cbind(gas_price_index_diff, cvx_price_diff)
data_diff <- na.omit(data_diff)

lag_selection <- VARselect(data_diff, lag.max = 10, type = "const") 
lag_selection
#Due to the result, there seems to be a  on controversy on choice of p, we choose 
#p = 2 which is overall smallest

# Fit our data to var
var_model <- VAR(data_diff, p = 2, type = "const")

# Extract fitted values from the VAR model
fitted_values <- fitted(var_model)

# Convert actual differenced data into a time series object for plotting consistency
actual_values <- ts(data_diff, start = start(data_diff), 
                    frequency = frequency(data_diff))
# Set up plotting area
par(mfrow = c(2, 1))  # 2 rows, 1 column layout for plotting

# Plot for the first time series (e.g., gas price index)
plot(actual_values[, 1], type = "l", col = "blue", lwd = 2, 
     main = "Actual vs Fitted - Gas Price Index",
     ylab = "Gas Price Index", xlab = "Time")
plot (fitted_values[, 1],type = 'l', col = "red", lwd = 2)
legend("topright", legend = c("Actual", "Fitted"), col = c("blue", "red"), 
       lty = c(1, 2), lwd = 2)

# Plot for the second time series (e.g., TAN closing price)
plot(actual_values[, 2], type = "l", col = "blue", lwd = 2, 
     main = "Actual vs Fitted - CVX Closing Price",
     ylab = "TAN Closing Price", xlab = "Time")
plot(fitted_values[, 2], type = 'l', col = "red", lwd = 2)
legend("topright", legend = c("Actual", "Fitted"), col = c("blue", "red"), 
       lty = c(1, 2), lwd = 2)

# Reset plotting area
par(mfrow = c(1, 1))

```

[**[ELABORATE WHAT YOU WILL TO DO HERE]**]{.underline}

```{r}
summary(var_model)
```

## (l) Impulse Response Functions (Jiaxuan)

[**[ELABORATE WHAT YOU WILL TO DO HERE]**]{.underline}

```{r}
# Compute impulse response functions for 10 periods ahead
irf_result <- irf(var_model, n.ahead = 10)
# Display the IRF results
irf_result

# Plot impulse response for "GASREGW"
response_gas <- irf_result$irf[["GASREGW"]][1:10]
lower_gas <- irf_result$Lower[["GASREGW"]][1:10]
upper_gas <- irf_result$Upper[["GASREGW"]][1:10]

plot(response_gas, type = "l", col = "blue", 
     ylim = range(c(lower_gas, upper_gas)),
     ylab = "Response", xlab = "Periods", main = "IRF of GASREGW")
lines(lower_gas, col = "red", lty = 2)
lines(upper_gas, col = "red", lty = 2)

# Plot impulse response for "CVX.Close"
response_cvx <- irf_result$irf[["CVX.Close"]][1:10]
lower_cvx <- irf_result$Lower[["CVX.Close"]][1:10]
upper_cvx <- irf_result$Upper[["CVX.Close"]][1:10]

plot(response_cvx, type = "l", col = "blue", ylim = range(c(lower_cvx, 
                                                            upper_cvx)),
     ylab = "Response", xlab = "Periods", main = "IRF of CVX.Close")
lines(lower_cvx, col = "red", lty = 2)
lines(upper_cvx, col = "red", lty = 2)

```

[**[ELABORATE WHAT YOU DID HERE]**]{.underline}

## (m) Granger-Causality (Sia)

## (n) Forecasting with VAR Model (Jiaxuan)

[**=======NOTES AND FEEDBACK START===========**]{.underline}

It's difficult to see the actual forecast. Can you include the original plot? Then, can you also create another plot with the window narrowed to the recent 20 data points so it is easier to see what is happening?

[**=======NOTES AND FEEDBACK END===========**]{.underline}

We can see that the model predicts both gas price and CVX price as a series almost the same as the last true value observed, unlike the gas price predicted by ARIMA which has a downward trend.

```{r}
# Generate a 12-step-ahead forecast with error bands
forecast_var <- predict(var_model, n.ahead = 12, ci = 0.95)
# Plot the forecast with error bands
plot(forecast_var,type = 'l',lwd = 2)

# Extract the forecast values for GASREGW and CVX.Close
gas_forecast <- forecast_var$fcst$GASREGW
cvx_forecast <- forecast_var$fcst$CVX.Close

```

# References

Federal Reserve Bank of St. Louis. (n.d.). *Weekly U.S. All Grades All Formulations Retail Gasoline Prices (GASREGW)*. FRED, Federal Reserve Bank of St. Louis. Retrieved November 14, 2024, from <https://fred.stlouisfed.org/series/GASREGW>

Yahoo Finance. (n.d.). *Chevron Corporation (CVX) Stock Price, News, Quote & History*. Retrieved November 14, 2024, from <https://finance.yahoo.com/quote/CVX/>
